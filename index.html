<!DOCTYPE html>
<html lang="en">

<head>
<meta charset="UTF-8">
<title>Retail Solution Attendance</title>

<!-- PDF -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.29/jspdf.plugin.autotable.min.js"></script>

<!-- Excel -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

<style>
body { font-family: Arial; background:#f4f4f9; margin:20px; }
h2 { text-align:center; }

.tabs { display:flex; justify-content:center; flex-wrap:wrap; gap:8px; margin-bottom:15px; }
.tab { padding:8px 15px; background:#ddd; border-radius:20px; cursor:pointer; font-weight:bold; }
.tab.active { background:#007BFF; color:#fff; }

table { width:90%; margin:auto; border-collapse:collapse; background:#fff; }
th,td { padding:10px; border:1px solid #ddd; text-align:center; }
th { background:#007BFF; color:white; }
tr:nth-child(even){ background:#f9f9f9; }

.in { color:green; font-weight:bold; }
.out { color:red; font-weight:bold; }
</style>
</head>

<body>

<h2>Retail Solution Attendance Logs</h2>

<div style="text-align:center;margin-bottom:15px;">
<select id="monthSelect" onchange="renderTable()">
<option value="all">All Months</option>
<option value="1">January</option><option value="2">February</option>
<option value="3">March</option><option value="4">April</option>
<option value="5">May</option><option value="6">June</option>
<option value="7">July</option><option value="8">August</option>
<option value="9">September</option><option value="10">October</option>
<option value="11">November</option><option value="12">December</option>
</select>

<button onclick="downloadPDF()">Download PDF</button>
<button onclick="downloadExcel()">Download Excel</button>
</div>

<div class="tabs" id="userTabs"></div>

<table id="attendance-table">
<thead>
<tr>
<th>UID</th>
<th>Name</th>
<th>Date</th>
<th>Day</th>
<th>Check-in</th>
<th>Check-out</th>
</tr>
</thead>
<tbody><tr><td colspan="6">Loading...</td></tr></tbody>
</table>

<script>
/* USERS */
const userMap = {
 "1":"MR Shuvo","2":"MD Omar Faruqe","3":"MR Fahim","4":"Mahabub Hossen Monir",
 "5":"MD Saiful","6":"Israt Jahan","7":"Afrina Tonni","8":"MD Asif Imtiaz"
};

let rawData = [];
let processedData = [];
let activeUser = "all";

/* TIME FORMAT */
function formatTime(t){
 return new Date(t).toLocaleString('en-US',{
  hour:'numeric',minute:'2-digit',second:'2-digit',hour12:true
 });
}

/* MONTH NAME */
function getMonthName(monthValue){
 const months = ["January","February","March","April","May","June",
                 "July","August","September","October","November","December"];
 if(monthValue==="all") return "All_Months";
 return months[parseInt(monthValue)-1];
}

/* DAY NAME */
function getDayName(dateString){
 const days = ["Sunday","Monday","Tuesday","Wednesday","Thursday","Friday","Saturday"];
 const d = new Date(dateString);
 return days[d.getDay()];
}

/* GROUP SAME DATE + CHECK-IN/CHECK-OUT LOGIC */
function processAttendance(data){
 const map = {};
 data.forEach(item=>{
  const d = new Date(item.time);
  const date = d.toISOString().split("T")[0];
  const key = item.user_id+"_"+date;

  if(!map[key]){
   map[key]={ uid:item.uid,user_id:item.user_id,date,checkIn:null,checkOut:null };
  }

  // 2PM rule
  if(d.getHours()<14 && !map[key].checkIn){
   map[key].checkIn = item.time;
  }
  if(d.getHours()>=14){
   map[key].checkOut = item.time;
  }
 });
 return Object.values(map).sort((a,b)=>new Date(b.date)-new Date(a.date));
}

/* LOAD JSON */
async function loadJSON(){
 const res = await fetch('attendance.json');
 rawData = await res.json();
 processedData = processAttendance(rawData);
 renderTable();
}

/* CREATE TABS */
function createTabs(){
 const div=document.getElementById('userTabs');
 div.innerHTML=`<div class="tab active" onclick="switchUser('all',this)">All</div>`;
 for(const id in userMap){
  div.innerHTML+=`<div class="tab" onclick="switchUser('${id}',this)">${userMap[id]}</div>`;
 }
}
function switchUser(id,el){
 activeUser=id;
 document.querySelectorAll('.tab').forEach(t=>t.classList.remove('active'));
 el.classList.add('active');
 renderTable();
}

/* FILTER DATA */
function getFiltered(){
 let d=processedData;
 if(activeUser!=="all") d=d.filter(x=>x.user_id===activeUser);
 const m=document.getElementById('monthSelect').value;
 if(m!=="all") d=d.filter(x=>new Date(x.date).getMonth()+1==m);
 return d;
}

/* RENDER TABLE */
function renderTable(){
 const tb=document.querySelector("tbody");
 const data=getFiltered();
 tb.innerHTML="";
 if(!data.length){ tb.innerHTML=`<tr><td colspan="6">No data</td></tr>`; return;}
 data.forEach(r=>{
 tb.innerHTML+=`
 <tr>
 <td>${r.uid}</td>
 <td>${userMap[r.user_id]}</td>
 <td>${r.date}</td>
 <td>${getDayName(r.date)}</td>
 <td class="in">${r.checkIn?formatTime(r.checkIn):"--"}</td>
 <td class="out">${r.checkOut?formatTime(r.checkOut):"--"}</td>
 </tr>`;
 });
}

/* ================= PDF DOWNLOAD ================= */
function downloadPDF(){
 const data=getFiltered();
 if(!data.length){ alert("No data to export"); return;}

 const {jsPDF}=window.jspdf;
 const doc=new jsPDF();

 const monthValue=document.getElementById("monthSelect").value;
 const monthName=getMonthName(monthValue);
 const title=activeUser==="all"
             ? `All Users Attendance (${monthName})`
             : `${userMap[activeUser]} Attendance (${monthName})`;
 doc.text(title,14,15);

 const rows = data.map(r=>[
  r.uid,
  userMap[r.user_id],
  r.date,
  getDayName(r.date),
  r.checkIn?formatTime(r.checkIn):"--",
  r.checkOut?formatTime(r.checkOut):"--"
 ]);

 doc.autoTable({
  head:[['UID','Name','Date','Day','Check-in','Check-out']],
  body:rows,
  startY:20
 });

 const fileName = (activeUser==="all"?"All_Users":userMap[activeUser])
                  + "_" + monthName + "_Attendance.pdf";

 doc.save(fileName.replaceAll(" ","_"));
}

/* ================= EXCEL DOWNLOAD ================= */
function downloadExcel(){
 const data=getFiltered();
 if(!data.length){ alert("No data to export"); return;}

 const monthValue=document.getElementById("monthSelect").value;
 const monthName=getMonthName(monthValue);
 const fileName = (activeUser==="all"?"All_Users":userMap[activeUser])
                  + "_" + monthName + "_Attendance.xlsx";

 const excelData = data.map(r=>({
  UID:r.uid,
  Name:userMap[r.user_id],
  Date:r.date,
  Day:getDayName(r.date),
  "Check-in":r.checkIn?formatTime(r.checkIn):"--",
  "Check-out":r.checkOut?formatTime(r.checkOut):"--"
 }));

 const ws=XLSX.utils.json_to_sheet(excelData);
 const wb=XLSX.utils.book_new();
 XLSX.utils.book_append_sheet(wb,ws,"Attendance");
 XLSX.writeFile(wb,fileName.replaceAll(" ","_"));
}

/* INIT */
createTabs();
loadJSON();
setInterval(loadJSON,5000);

</script>

</body>
</html>
